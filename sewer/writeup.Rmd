---
output: html_document
---
# Temperature-dependence in sewer blockage frequency
### Josh Nightingale, Christian Gunninng and Mark Holstad
### `r date()`


```{r setup, include=FALSE, cache=FALSE}
# Code to set up knitr settings and libraries used every time
library(knitr)
## 
opts_chunk$set(dev=c('png', 'tiff'),
    dpi=c(96, 300),
    dev.args=list( 
        png = list(type="cairo"),
        tiff = list(compression="lzw")
    )
)

## print xtables as html
my.xtable <- function(x,...) print(xtable(x, ...), type='html')
my.startable <- function(x,...) stargazer(x, type='html', ...)
## set up figure numbers and captions
source('prep.knitr.markup.R')

set.seed(76543); # recompile will have same random numbers
# set global chunk options
## josh: this line never works on my machine and causes compiling to fail...
#opts_chunk$set(fig.align='center', fig.show='hold', concordance=TRUE, tidy=T)
options(replace.assign=TRUE, width=70)
#setwd('/home/josh/unm-r-programming/sewer')
Sys.setenv(TEXINPUTS=getwd(),
           BIBINPUTS=getwd(),
           BSTINPUTS=getwd())
library(lattice)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(plyr)
library(xtable)
library(weathermetrics) ## F to C
library(HH) # for fancy ancova plot
library(lme4) # for glmer - mixed effects (nested interceptors / manholes)
library(AER)
library(pscl) # for ZIP models
library(xts)
library(MASS)
library(stargazer)
## helper functions
source('mk.helpers.R')
```

```{r read_data, size='footnotesize', include=FALSE}
#source('run.weather.R')
source('run.read_data.R')
```

```{r model_sew_temp, echo=FALSE, size='footnotesize', include=FALSE}
source('run.model_sew_temp.R')
```
```{r tempandblock, fig.cap='Linear model diagnostic plots.', size='footnotesize', message=FALSE, warning=FALSE, error=FALSE, echo=FALSE, include=FALSE}
## prepare linear models / diagnosis plots
## was source('sewtempandblock.R')
source('run.glms.R')
```
```{r grease_plots, size='footnotesize', echo=FALSE, message=FALSE, warning=FALSE, error=FALSE, include=FALSE}
## includes models
source('run.grease_plots.R')
```

# Methods

### Data
Albuquerque Bernalillo County Water Utility Authority (ABCWUA) responds to SSB events after discovery by maintenance workers or reports of blockages from the public. This study used an anonymised dataset of SSB dates, along with engineers' estimates of blockage cause. In total, `r nrow(sewer)` SSB reports from the period `r format(range(sewer$day, na.rm=T)[1], '%B %d, %Y')` - `r format(range(sewer$day, na.rm=T)[2], '%B %d, %Y') ` (inclusive) were used in this study.
The frequency of sanitary sewer blockages is the primary focus of this work.

Various testing is performed to verify cost-effective chemical odor control on three north-south interceptor sewers in the ABCWUA system, which are shown in Figure S1. The testing includes grab samples obtained by the chemical treatment vendor at 15 manholes on the three treated interceptors. The sewage grab sample measurements were obtained, typically bi-weekly, using a Cooper Atkins DPP400W Waterproof Pen Style thermometer with an accuracy range of +/- 1 C° (from -10° to 100°C) in a liquid sample collected from the manhole.  
In total, `r nrow(sewtemp)` SGST measurements from the period `r format(range(sewtemp$Date, na.rm=T)[1], '%B %d, %Y')` - `r format(range(sewtemp$Date, na.rm=T)[2], '%B %d, %Y') ` (inclusive) were used in this study.

Mean daily air temperature (MDAT) was obtained from the Albuquerque International airport's (KABQ) automated METAR data collection system (available from \url{http://www.wunderground.com/history/airport/KABQ}) spanning the years during which either SSB and SGST or measurements were available (`r format(range(weather$Date, na.rm=T)[1], '%B %d, %Y')` - `r format(range(weather$Date, na.rm=T)[2], '%B %d, %Y') `, inclusive).

Since most days had no SSB events, the total number of SSB 
events per week (W-SSB) was computed and used in subsequent 
analysis. 
For comparison with SSB data, MDAT measurements were averaged by week to yield mean weekly MDAT (MW-MDAT).
In addition, SGST measurements were averaged by week (all interceptors were combined), 
yielding mean weekly SGST (MW-SGST).
In all analyses that included MW-SGST, weeks without SGST measurements were excluded.

### Linear models

First, we used ordinary linear models to estimate the response of MW-SGST to MW-MDAT, 
interceptor identity, and manhole identity. For final selection of linear model specifications, both Bayes'information criterion (BIC) and parsimony considerations 
were employed. 
In favor of parsimony, and due to the small effect sizes and/or statistical non-significance, 
interceptor and manhole identity were excluded from subsequent models. 

Next, we used generalized linear models (GLM) to estimate the response of W-SSB to either MW-SGST or MW-MDAT.  
We also used a GLM to estimate the response of W-SSB to both MW-MDAT and blockage cause.  Due to low sample numbers, the response of W-SSB to both MW-SGST and blockage cause was not estimated.

All analysis was conducted with the R statistical programming environment \parencite{cran}.

# Results

### Air temperature (MW-MDAT) and sewage temperature (MW-SGST)

We found that sewage temperature increased with air temperature (Figure \ref{fig:sewweathplot}).
Indeed, the best-ranked model of the response of MW-SGST to MW-MDAT (Table \ref{tab:bestlin}) explained the majority of variation in MW-SGST (R^2 = `r .best.rsq`).
 However, as air temperature fells below freezing, little further decrease in sewage temperatures was observed (Figure \ref{fig:sewweathplot}).

For reference, all candidate models (ranked by BIC) are shown in Table \ref{tab:bictab}. All high-ranked models (low BIC) show a small but statistically significant effect of interceptors identity on sewage temperature. On the other hand, all models that 
included manhole identity ranked lower than the null model (which included only MW-MDAT and MW-SGST).

```{r sewweathplot, echo=FALSE, size='footnotesize', include=TRUE, fig.height=4, fig.width=6, fig.cap="Sewage temperature (MW-SGST) increased with air temperature (MW-MDAT). The response of sewage temperature to air temperature differed slightly between sewer system interceptors. Overall, as air temperature dropped below freezing, no further decrease in sewage temperature was observed."}
# plot with ggplot
p <- ggplot(sewtemp.weather)
p <- p + geom_point(aes(x=MeanTempC, y=SewTempC, 
                        colour=Interceptor, shape=Interceptor)) 
p <- p + scale_shape_manual(values=c(21, 23, 24))
p <- p + geom_smooth(aes(x=MeanTempC, y=SewTempC, 
                         colour=Interceptor, linetype=Interceptor), method='lm')
p <- p + theme_classic()
p <- p + theme(legend.position=c(0.85, 0.2))
p <- p + xlab('MW-MDAT (°C)') + ylab('MW-SGST (°C)')
print(p)
```


```{r multiblockplot, echo=FALSE, fig.pos='h', fig.width=10, fig.height=5, fig.cap=sprintf('Both sewage temperature (*A*: n=%d weeks, D=%s) and air temperature (*B*: n=%d weeks, D=%s) are statistically significant predictors of sanitary sewer blockages in Albuquerque, NM. The explanatory power of air temperature, however, is very small.', block.sewtemp.nb$nobs, block.sewtemp.nb$dev, block.airtemp.nb$nobs, block.airtemp.nb$dev), message=FALSE}
grid.arrange(block.sewtemp.nb$plot, block.airtemp.nb$plot, nrow=1)
```

### Sewage temperature (MW-SGST), air temperature (MW-MDAT), and sewer blockage frequency (W-SSB)

Overall, we found that sewer blockages occured more frequently during weeks with lower sewage temperatures (Figure \ref{fig:multiblockplot}A). 
The W-SSB data followed an overdispersed Poisson 
distribution, with forty-one weeks (23.8%??) showing one or 
zero incidents.
Consequently, we
employed a negative binomial generalized linear model (GLM) 
with a log link function \cite{mass} to model the response of W-SSB to MW-MDAT.
We also tested a Poisson GLM, but the final negative binomial GLM specification proved a much better model
 (likelihood ratio test, p < 0.001).
<!-- `r sprintf('$p < 0.001?? %s$', lrtest.sewtemp$Pr)` -->

The final model showed a highly statistically significant relationship between sewage temperature (MW-SGST) and sewer blockage frequency (W-SSB) (p < 0.001; Table \ref{tab:tempandblock}), 
R^2 statistics are not available for GLM, though the proportional reduction in deviance (D) provides an analogous measure of the model's explanatory power \parencite{zheng2000summarizing}. For the final negative binomial model, we find that D = `r  block.sewtemp.nb$dev`.
Thus this model explains only a modest amount of 
variation in observed sewer blockage frequency.

As with sewage temperature, we found low air temperature was associated with more sewer blockages. MW-MDAT was a highly significant predictor of W-SSB (Table \ref{tab:sewnb}; Figure \ref{fig:multiblockplot}B).  However, this model explains very little variation in blockage frequency (D = `r block.airtemp.nb$dev`).

### Causes of sewer blockage frequency (W-SSB)
Above, we see that sanitary sewer blockage frequency (W-SSB) is weakly correlated with both air and sewage temperature.   While both sewage and air temperature are poor predictors, sewage temperature is somewhat better. Yet sewage temperature measurements are expensive and labor-intensive, and thus sparse relative to automated air temperature measurements.  As such, a direct comparison between models is not possible. 

This dataset includes `r grease$sum` total blockages where grease was the estimated blockage cause, representing `r sprintf("%2.1f", grease.ratio * 100)`\% of total incidents during the study period. We constructed a Poisson GLM  using both air temperature (MW-MDAT) and blockage cause (grease vs not grease) as predictor variables.  Here, both air temperature and blockage cause are highly significant and inter-dependent predictors of blockage frequency (Figure \ref{fig:multifigplot} and Table \ref{tab:greasetab}).   The full model explains a sizable proportion of variation in blockage frequency (D = `r grease.fullmod$dev`), particularly for grease-caused blockages (Figure \ref{fig:multifigplot}A).


```{r multifigplot, echo=FALSE, fig.pos='h', fig.width=10, fig.height=5, fig.cap=sprintf('Mean weekly air temperature predicts blockages caused by grease (A: n=%d weeks), but is a poor predictor of blockages due to other causes (B: n=%d weeks). See Table ?? for model details.', grease$nobs, not.grease$nobs),  message=FALSE}
grid.arrange(grease.fullmod$plot.grease, grease.fullmod$plot.not.grease, nrow=1)
```

# Discussion
Notes / todo:
??both sewer temp and air temp are signif predictors,
sewer temp is better
??likely that the reponse of sewer temp to air temp is dependent on local local climate and sewer configuration (mark?), warrants testing in different locales.  ABQ diurnal temp, elevation gradient and cold air drainage.
??if municipalities are already collecting SGST, it would be an appropriate addition to system maintainance planning

Air temperature data, which are widely and freely available, have modest utility in predicting sewer blockages over weekly timescales. It is useful for practitioners to understand variables impacting SSOs, even with a weak relationship. Consideration could be given in sewer design to select locations subject to higher winter temperatures, either through greater depth or under asphalt pavement. These results also suggest that areas experiencing increasing average temperatures may find that this trend alleviates the pressure placed on sewage systems by FOG deposits. Similarly, weather forecasts and real-time weather observations may prove useful for predicting and responding rapidly to blockages, reducing the threat to property and public health. 

Data from sewer measurements are a slightly more accurate predictor of blocking frequency. Where these data are regularly collected and rapidly analysed, they could be used in place of air temperature to anticipate problems in sanitation infrastructure and plan system maintenance. 

Both sewage and air temperature are significant predictors of SSOs, with sewage temperature being the superior predictor. The sewage temperature is understood to be primarily driven by soil temperatures (author’s communication with Dr. Jes Vollertsen, 2014). Literature is available (e.g., \cite{Hasfurther1972}) to predict soil temperature from air temperature in a non-urban area. The relationship between air and soil temperature is likely to be mediated by groundwater levels. The difference in predictive ability between sewage and air temperature may reflect the variable groundwater levels during the seasonal cycle in Albuquerque. Similarly, differences between interceptors and manholes may reflect elevation and land use, via their effects on groundwater temperature. Models including precipitation patterns and/or local physical characteristics (e.g. water table height, land use, sewer configuration, soil type, geology) could test this hypothesis. 

Because lower temperatures occur coincidental to the Thanksgiving and Christmas season in the Northern Hemisphere, it is possible that FOG related SSOs increase during the holiday season but not due to higher levels of holiday generated FOG. Further study of SSO rates versus holiday seasons for Southern Hemisphere utilities may be enlightening. Further study may be appropriate of temperature impacts to FOG transformations in the sewer and to seasonal variations in FOG levels. 

With continuing population rise and urbanisation, efficient operation of urban waste-water infrastructure is an increasingly important issue for global public health. \cite{Sato2013} recently highlighted the importance of more research into efficacy of waste-water treatment techniques, particularly in the developing world. The data in this study were not collected specially for research purposes. Rather, this study used data already collected by industry as part of standard operations, married with publicly accessible weather data available online. This demonstrates the potential usefulness of historic industry datasets for addressing future challenges. 

# Tables
??Need table numbers.

```{r tabtempandblock, echo=FALSE, results='asis'}
.l <- block.sewtemp.nb
my.startable( .l$mod, 
    title=sprintf('Weekly mean sewage temperature predicts the number of blocked sewers that week (Negative Binomial model, n=%d weeks, D=%s)', .l$nobs, .l$dev), 
    label='tab:tempandblock'
)
```


```{r greasetab, echo=FALSE, results='asis'}
my.startable( grease.fullmod$mod, 
    title=sprintf('Poisson GLM predicting blockage frequency as a function of air temperature and cause (grease versus not grease).'), 
    label='tab:greasetab'
)
```


#References


# Supplemental Information

```{r sewnb, results='asis', echo=FALSE}
.l <- block.airtemp.nb
my.startable(
    .l$mod, 
    title=sprintf('Weekly mean air temperature predicts the number of blocked sewers that week (Negative binomial model, n=%d weeks, D=%s)', .l$nobs, .l$dev), 
    label='tab:sewnb'
)
```

```{r bictab, echo=FALSE, size='footnotesize', results='asis'}
names(.lin.bic) <- c('Model', 'BIC')
# calculate Delta BIC
.lin.bic$Delta <- c('-', # first element of vector is blank
                    round( digits=1,   # for table
                           x = cumsum( # cumulative difference from top model
                             diff(.lin.bic$BIC) ) ) ) # calcs differences
my.xtable(.lin.bic, label='tab:bictab', caption='Candidate models for predicting sewage temperature using mean air temperature, ranked using Bayes Information Criterion. Delta BIC, the difference between each model and its highest-ranked competitor, is a measure of empirical support for that model. A value over $> 10$ is considered strong evidence against that model (Kass and Raftery, 1995)')
```

```{r bestlin, echo=FALSE, size='footnotesize', results='asis'}
my.startable(.lin.best[[1]], 
    ## column formatting, first element is rownames
    #display = c('s', 'fg', 'g', 'f', 'g'),
    digits=3,
    label='tab:bestlin', 
    title=sprintf('Summary table of the best-ranked model of the response of mean weekly sewage grab sample temperature (MW-SGST) to mean weekly mean daily air temperature (MW-MDAT). Sewer interceptor identity has a significant effect on both model slope and model intercept. $R^2 = %s$.', .best.rsq)
)
```

??Summary of the same linear model in xtable, 
xtable html output is ugly in browser, but
looks fine in libreoffice
```{r bestlin1, echo=FALSE, size='footnotesize', results='asis'}
## as above, but with xtable
my.xtable(summary(.lin.best[[1]]), 
    ## column formatting, first element is rownames
    display = c('s', 'fg', 'g', 'f', 'g'),
    digits=3,
    label='tab:bestlin', 
    caption=sprintf('Summary table of the best-ranked model of the response of mean weekly sewage grab sample temperature (MW-SGST) to mean weekly mean daily air temperature (MW-MDAT). Sewer interceptor identity has a significant effect on both model slope and model intercept. $R^2 = %s$.', .best.rsq)
)
```
<!-- diagnosis --> 
```{r diag, fig.cap='Linear model diagnostic plots.', size='footnotesize', message=FALSE, warning=FALSE, error=FALSE, echo=FALSE, include=FALSE}

#summary(sewer.ps)
# can compare with likelihood ratio test as Poisson model is nested in negbin
## moved to 
"Airtemp lrtest"
#lrtest.airtemp
"grease lrtest"
#grease$lrtest
"not grease lrtest"
#not.grease$lrtest
#lrtest(sewer.nb, sewer.ps) # negbin is a very significant improvement; 
##
```
