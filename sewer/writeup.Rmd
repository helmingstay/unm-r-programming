---
output: 
    html_document:
      css: custom.css
      fig_caption: TRUE
      fig_width: 4.5
---
# Temperature-dependence in sewer blockage frequency
### Josh Nightingale, Christian Gunninng and Mark Holstad
### `r date()`


```{r setup, include=FALSE, cache=FALSE}
# Code to set up knitr settings and libraries used every time
library(knitr)
## 
opts_chunk$set(dev=c('png', 'tiff'),
    dpi=c(150, 300),
    dev.args=list( 
        png = list(type="cairo-png", antialias='subpixel'),
        tiff = list(compression="lzw")
    )
)

## print xtables as html
my.xtable <- function(x,...) print(xtable(x, ...), type='html')
my.startable <- function(x,...) stargazer(x, type='html', ...)
## set up figure numbers and captions
source('prep.knitr.markup.R')

set.seed(76543); # recompile will have same random numbers
# set global chunk options
## josh: this line never works on my machine and causes compiling to fail...
#opts_chunk$set(fig.align='center', fig.show='hold', concordance=TRUE, tidy=T)
options(replace.assign=TRUE, width=70)
#setwd('/home/josh/unm-r-programming/sewer')
Sys.setenv(TEXINPUTS=getwd(),
           BIBINPUTS=getwd(),
           BSTINPUTS=getwd())
library(lattice)
library(ggplot2)
library(gridExtra)
library(reshape2)
library(plyr)
library(xtable)
#library(weathermetrics) ## F to C
#library(HH) # for fancy ancova plot
library(lme4) # for glmer - mixed effects (nested interceptors / manholes)
#library(AER)
#library(pscl) # for ZIP models
library(xts)
library(MASS)
library(stargazer)
## helper functions
source('mk.helpers.R')
```

```{r read_data, size='footnotesize', include=FALSE}
## this also sources run.model_sew_temp.R
source('run.read_data.R')
```

```{r mod_lags, echo=FALSE, size='footnotesize', include=FALSE}
source('run.lag_period.R')
## not interesting? retest w/running mean temps...
#source('run.test.binom.R')
```
```{r tempandblock, fig.cap='Linear model diagnostic plots.', size='footnotesize', message=FALSE, warning=FALSE, error=FALSE, echo=FALSE, include=FALSE}
## prepare linear models / diagnosis plots
## was source('sewtempandblock.R')
source('run.glms.R')
```

# Methods

### Data
Albuquerque Bernalillo County Water Utility Authority (ABCWUA) responds to SSB events after discovery by maintenance workers or reports of blockages from the public. This study used an anonymised dataset of SSB dates, along with engineers' estimates of blockage cause. In total, `r sewer.stats$nobs` SSB reports from the period `r sewer.stats$min` to `r sewer.stats$max` (inclusive) were used in this study.  For simplicity, we categorize all reported causes as either grease related or non-grease related.
The frequency of sanitary sewer blockages is the primary focus of this work.

As part of an unrelated ABCWUA system odor control survey, sewage temperature was obtained via grab samples by 
a chemical treatment vendor at 15 manholes on three treated north-south interceptors.  A map of these 
three interceptor is shown in Figure S1. Temperature measurements were obtained, typically bi-weekly, using a 
Cooper Atkins DPP400W Waterproof Pen Style thermometer with an accuracy range of +/- 1 C° (from -10° to 100°C) 
in a liquid sample collected from the manhole.  
In total, `r nrow(sewtemp)` sanitary sewer temperature (ST) measurements from the period `r sewtemp.stats$min` 
to `r sewtemp.stats$max` (inclusive) were used in this study.

Mean daily air temperature (mAT/D) was obtained from the Albuquerque International airport's (KABQ) automated METAR data collection system (available from \url{http://www.wunderground.com/history/airport/KABQ}) spanning the entire period of study noted above.

Since most days had no SSB events, the total number of SSB 
events per week (SSB/W) was computed and used in subsequent 
analysis. 
For comparison with SSB data, mAT/D measurements were averaged by week to yield mean weekly air temperature (mAT/W).
In addition, ST measurements were averaged by week (all interceptors were combined), 
yielding mean weekly SGST (mST/W).
In all analyses that included mST/W, weeks without ST measurements were excluded.
A time series of SSB events per week, for all causes and grease-related causes, is shown in Figure \ref{fig:blockts}.

```{r blockts, echo=FALSE, size='footnotesize', include=TRUE, fig.height=4.5, fig.width=4.5, fig.cap="Blockage events per week, for all causes and grease-related causes.  Seasonality of both time series is evident. An exceptional spike of blockages in April 2011 follows a record-breaking cold spell in February 2011.  Likewise, the dearth in blockages in early 2014 and 2015 correspond with historic warm winters in those years."}
xyplot(block.plot.xts, type=c('h','g'), col='black', xlab='', ylab='SSB events per week (SSB/W)')
```

### Linear models
First, we seek to quantify the dependence of sewer temperature on air temperature using a set of linear models. Exploratory data analysis shows that manhole identity does not reliably covary with sewage temperature, while both interceptor identity and air temperature are significant predictors of sewage temperature.

To account for the lag between air temperature and sewer temperature, we compute the moving average of air temperature 
over a varying number of days N.  For each N, we fit a linear model (using a MANOVA model structure) that includes interceptor identity and N-day mean air temperature as predictors.  We then select N to maximize model $R^2$.

Next, we seek to quantify the dependence of blockage frequency on temperature.  We start by considering blockages of all causes, and model their dependence on either sewage temperature or air temperature.  Due to the sparcity of sewage temperature data, we then focus on air temperature, and model blockages by both cause and the N-day mean air temperature.  Finally, we conduct a detailed analysis of the dependence of grease-caused blockages on N-day mean air temperature.

All analysis was conducted with the R statistical programming environment \cite{cran}.

# Results

### Mean weekly air temperature (mAT/W) and sewage temperature (mST/W)

Overall, we found that air temperature, averaged over the preceding `r best.ndays` days, was a very good 
predictor of sewage temperature (Figure \ref{fig:sewweathplot}).
Indeed, the final model of sewage temperature versus air temperature and interceptor identity (Table \ref{tab:bestlin}) explained the majority of variation in mST/W (R^2 = `r .best.rsq`).
 However, as air temperature falls below freezing, little further decrease in sewage temperatures was observed (Figure \ref{fig:sewweathplot}).

We further analysed the effect of local 
geography on linear model results.
In all high-ranked linear models, interceptor identity exhibits a small but statistically significant effect of on sewage temperature, while manhole identity was not a significant predictor.
Nonetheless, the effect size of either manhole and interceptor identity is small, and we do not consider local geographic effects further.

```{r sewweathplot, echo=FALSE, size='footnotesize', include=TRUE, fig.height=4.5, fig.width=4.5, fig.cap="Sewage temperature (mST/W) increased with air temperature (mAT/W). The response of sewage temperature to air temperature differed slightly between sewer system interceptors, See Table \ref{tab:bestlin} for model details (R^2 = `r .best.rsq`)."}

# plot with ggplot
## data from best model in run.model_sew_temp.R
p <- ggplot(best.dat)
p <- p + geom_point(aes(x=MeanTempC, y=SewTempC, 
                        colour=Interceptor, shape=Interceptor)) 
p <- p + scale_shape_manual(values=c(21, 23, 24))
p <- p + geom_smooth(aes(x=MeanTempC, y=SewTempC, 
                         colour=Interceptor, linetype=Interceptor), method='lm')
p <- p + theme_classic()
p <- p + theme(legend.position=c(0.85, 0.2))
p <- p + xlab('mAT/W (°C)') + ylab('mST/W (°C)')
print(p)
```


### Sewage temperature (mST/W), air temperature (mAT/W), and sewer blockage frequency (SSB/W)

```{r multiblockplot, eval=T, echo=FALSE, fig.pos='h', fig.width=4.5, fig.height=3.5, fig.cap=sprintf('Mean weekly sewage temperature (n=%d weeks, D=%s) and mean weekly air temperature (n=%d weeks, D=%s) are both statistically significant predictors of sanitary sewer blockage frequency in Albuquerque, NM. Here, blockages of all causes are shown.  Note that sewer temperature is only available for select weeks, while air temperature is available for the entire period of blockage record.', block.sewtemp.list$nweeks, block.sewtemp.list$dev, block.airtemp.list$nweeks, block.airtemp.list$dev), message=FALSE}
plot(block.bothtemp.list$plot)
```

We begin with an examination of all blockages, regardless of reported cause.
We modeled the response of sewer blockage frequency (SSB/W) to either air temperature (mAT/W) or sewage temperature (mST/W) using a Poisson GLM.
Overall, we found that both sewage temperature and air temperature were weak but statistically significant predictors of  
sewer blockage frequency (Figure \ref{fig:multiblockplot}, 
Table \ref{tab:tempandblock}),
R^2 statistics are not available for GLM, though the proportional reduction in deviance (D) provides an analogous measure of the model's explanatory power \cite{zheng2000summarizing}. For the final models, we find that D = `r  block.bothtemp.list$devs$Air` (air temperature) and  D = `r  block.bothtemp.list$devs$Sewer` (sewer temperature).  

In the above models, sewer temperature appears to be a better predictor of blockage frequency than air temperature.
However, the two models are not directly comparable due to differences in sampling period. Sewage temperature measurements are expensive and labor-intensive, which in turn limits sample coverage.
Air temperature records, on the other hand, are freely available from automated weather stations worldwide, including all major airports.  Consequently, air temperature records cover the entire period of sewer blockage records.

### Causes of sewer blockage frequency (SSB/W)

Next, we explore the dependence of blockage frequency 
on reported blockage cause, grouped into grease versus not grease.  Again, we conduct separate analyses for air and sewage temperature using Poisson GLM.

This dataset includes `r block.counts$grease` total blockages where grease was the estimated blockage cause, representing `r sprintf("%2.1f", grease.ratio * 100)`\% of total incidents during the study period. We constructed a Poisson GLM  using both air temperature (mAT/W) and blockage cause (grease vs not grease) as predictor variables.  Here, both air temperature and blockage cause are highly significant predictors of blockage frequency (Figure \ref{fig:block.airtemp} and Table \ref{tab:greasetab}). Again, there is a strong interaction between temperature and blockage cause, with grease-caused blocks responding more strongly to temperature.   The full model explains a sizable proportion of variation in blockage frequency (D = `r block.airtemp.list$dev`), particularly for grease-caused blockages (Figure \ref{fig:block.airtemp}A).

```{r block.sewtemp, echo=FALSE, fig.pos='h', fig.width=4.5, fig.height=3.5, fig.cap=sprintf('Mean weekly sewer temperature predicts blockages caused by grease (D=%s), and is a poor predictor of blockages due to other causes (D=%s). Models include %d weeks total. See Table ?? for model details.', block.sewtemp.list$dev.grease, block.sewtemp.list$dev.nogrease, block.sewtemp.list$nweeks), message=FALSE}
plot(block.sewtemp.list$plot)
```

```{r block.airtemp, echo=FALSE, fig.pos='h', fig.width=4.5, fig.height=3.5, fig.cap=sprintf('Mean weekly air temperature predicts blockages caused by grease (%d total blocks, D=%s), and is a poor predictor of blockages due to other causes (%d total blocks, D=%s). %d weeks total. See Table ?? for model details.', block.counts$grease, block.airtemp.list$dev.grease, block.counts$not.grease,  block.airtemp.list$dev.nogrease, block.airtemp.list$nweeks), message=FALSE}
plot(block.airtemp.list$plot)
```

Additional model validation was conducted by subdividing the
period of record.  The response of weekly grease blockage 
frequency to air temperature was fit using observations prior
to `r block.airtemp.pred$cutoff` (`r nrow(block.airtemp.pred$dat)` weeks).  The resulting model was 
used to predict grease blockage frequency in the weeks after
`r block.airtemp.pred$cutoff` (`r nrow(block.airtemp.pred$pred)` weeks).  The results, shown in Figure \ref{fig:validate}, indicate that model predictions generally capture the observed 
pattern of grease blockage frequency.


```{r validate, echo=FALSE, fig.pos='h', fig.width=4.5, fig.height=3.5, fig.cap=sprintf('Model validation comparing predicted and observed weekly grease blockage frequency. To generate predictions, a model was fit using weeks prior to %s (%s weeks total).  Observed air temperatures in subsequent weeks (%s weeks total) were used to predict grease blockage frequency (X-axis). Also plotted are the observed grease blockage frequencies in those weeks (Y-axis).', block.airtemp.pred$cutoff, nrow(block.airtemp.pred$dat), nrow(block.airtemp.pred$pred) ), message=FALSE}
plot(block.airtemp.pred$plot)
```

# Discussion

The suggestive link between air temperature and sewer blockage frequency shown above, coupled with the ease of collecting air temperature records, makes air temperature an attractive 

Notes / todo:
??both sewer temp and air temp are signif predictors,
sewer temp is better
??likely that the reponse of sewer temp to air temp is dependent on local local climate and sewer configuration (mark?), warrants testing in different locales.  ABQ diurnal temp, elevation gradient and cold air drainage.
??if municipalities are already collecting SGST, it would be an appropriate addition to system maintainance planning

Air temperature data, which are widely and freely available, have modest utility in predicting sewer blockages over weekly timescales. It is useful for practitioners to understand variables impacting SSOs, even with a weak relationship. Consideration could be given in sewer design to select locations subject to higher winter temperatures, either through greater depth or under asphalt pavement. These results also suggest that areas experiencing increasing average temperatures may find that this trend alleviates the pressure placed on sewage systems by FOG deposits. Similarly, weather forecasts and real-time weather observations may prove useful for predicting and responding rapidly to blockages, reducing the threat to property and public health. 

Data from sewer measurements are a slightly more accurate predictor of blocking frequency. Where these data are regularly collected and rapidly analysed, they could be used in place of air temperature to anticipate problems in sanitation infrastructure and plan system maintenance. 

Both sewage and air temperature are significant predictors of SSOs, with sewage temperature being the superior predictor. The sewage temperature is understood to be primarily driven by soil temperatures (author’s communication with Dr. Jes Vollertsen, 2014). Literature is available (e.g., \cite{Hasfurther1972}) to predict soil temperature from air temperature in a non-urban area. The relationship between air and soil temperature is likely to be mediated by groundwater levels. The difference in predictive ability between sewage and air temperature may reflect the variable groundwater levels during the seasonal cycle in Albuquerque. Similarly, differences between interceptors and manholes may reflect elevation and land use, via their effects on groundwater temperature. Models including precipitation patterns and/or local physical characteristics (e.g. water table height, land use, sewer configuration, soil type, geology) could test this hypothesis. 

Because lower temperatures occur coincidental to the Thanksgiving and Christmas season in the Northern Hemisphere, it is possible that FOG related SSOs increase during the holiday season but not due to higher levels of holiday generated FOG. Further study of SSO rates versus holiday seasons for Southern Hemisphere utilities may be enlightening. Further study may be appropriate of temperature impacts to FOG transformations in the sewer and to seasonal variations in FOG levels.

With continuing population rise and urbanisation, efficient operation of urban waste-water infrastructure is an increasingly important issue for global public health. \cite{Sato2013} recently highlighted the importance of more research into efficacy of waste-water treatment techniques, particularly in the developing world. The data in this study were not collected specially for research purposes. Rather, this study used data already collected by industry as part of standard operations, married with publicly accessible weather data available online. This demonstrates the potential usefulness of historic industry datasets for addressing future challenges. 

# Tables
??Need table numbers.

```{r tabtempandblock, echo=FALSE, results='asis'}
with(block.sewtemp.list,
my.xtable( mod, 
    caption=sprintf('Weekly mean sewage temperature and blockage cause predict weekly blockage frequency ( Poisson GLM, n=%d weeks, D=%s)', nweeks, dev), 
    label='tab:tempandblock'
))
```


```{r greasetab, echo=FALSE, results='asis'}
with(block.airtemp.list,
    my.xtable(mod, caption=sprintf('Weekly mean air temperature and blockage cause predicts weekly blockage frequency ( Poisson GLM, n=%d weeks, D=%s)', nweeks, dev), 
    label='tab:greasetab'
))
```


# References

# Supplemental Information

```{r airtemp.ndays.mod, echo=FALSE, fig.pos='h', fig.width=4.5, fig.height=4, fig.cap=sprintf('Goodness-of-fit profile of linear model predicting sewer temperature from mean air temperature.  For a range of N, air temperature was averaged over the N days preceding each sewer temperature sample.  N = %d yields the best model, with $R^2$ = %1.2f. Note that results are not highly sensitive to N, with 30 < N < 50 all yielding good models.', best.ndays, .best.rsq )}
#source('run.weather.R')
xyplot(adj.r.sq ~ ndays, rsq.ndays, type=c('l','g'), 
    xlab='Number of days air temperature mean',
    ylab=expression(Linear ~ Model ~ R^2)
)
```

```{r bestlin1, echo=FALSE, size='footnotesize', results='asis'}
## as above, but with xtable
my.xtable(summary(.lin.best),
    ## column formatting, first element is rownames
    display = c('s', 'fg', 'g', 'f', 'g'),
    digits=3,
    label='tab:bestlin',
    caption=sprintf('Summary table of the model of the response of mean weekly sewage grab sample temperature (MW-SGST) to mean weekly mean daily air temperature (MW-MDAT). Sewer interceptor identity has a significant effect on model intercept. $R^2 = %1.2f$.', .best.rsq)
)
```
